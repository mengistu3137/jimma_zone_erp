generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}
enum AnnouncementType {
  OFFICE
  OFFICE_CHILDREN
  PUBLIC
}
enum AttendanceStatus {
  PRESENT
  LATE
  PERMISSION
  LEAVE
  ABSENT
}
enum LeaveType{
  MATERNITY
  PATERNITY
  SICK
  ANNUAL
  CASUAL
  Bereavement 
}
enum APPROVALSTATUS {
  PENDING
  REJECTED
  APPROVED
  ACCEPTED
}
enum GENDER {
  MALE
  FEMALE
}
enum EmergencyRelation {
  BROTHER
  MOTHER
  FATHER
  SISTER
  UNCLE
  FRIEND
  WIFE
  HUSBAND
}
enum AttendanceType{
  morningCheckIn
  morningCheckOut
  afternoonCheckIn
  afternoonCheckOut
}
model Announcement {
  id        String            @id @default(cuid())
  officeId  String?
  office    Office?           @relation(fields: [officeId], references: [id])

  subject   String
  body      String
  date      DateTime          @default(now())
  filePath  String?
  type      AnnouncementType

  views     Int          @default(0)     
  expiresAt DateTime?                 
  pinned    Boolean     @default(false)

  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  deletedAt DateTime?

  @@index([officeId])
  @@map("announcements")
}

model User {
  id               String          @id @default(cuid())
  email            String          @unique
  username         String?         @unique
  password         String 
  name             String
  middle_name      String
  officeId         String?
  office           Office?         @relation(fields: [officeId], references: [id])
  appointments     Appointment[]
  attendance       Attendance[]
  employee         Employee? 
  officeLeadership OfficeLeader[] 
  authoredLetters  Letter[]        
  approvedLetters  Letter[]        @relation("ApprovedLetters") 
  directedLetters  DirectedLetter[] 
  roles            UserRole[]

   approvedLeaveRequests LeaveRequest[] 

  isActive         Boolean  @default(true)
  deletedAt        DateTime?

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  @@index([officeId]) 
  @@map("users")
}

model Role {
  id            String             @id @default(cuid())
  name          String             @unique
  description   String?
  archived      Boolean            @default(false)
  permissions   RolePermission[]
  users         UserRole[]
  deletedAt     DateTime?

  @@map("roles")
}

model Permission {
  id            String             @id @default(cuid())
  name          String             @unique
  description   String?
  roles         RolePermission[]
  deletedAt     DateTime?

  @@map("permissions")
}

model RolePermission {
  id             String      @id @default(cuid())
  roleId         String
  permissionId   String
  permission     Permission  @relation(fields: [permissionId], references: [id])
  role           Role        @relation(fields: [roleId], references: [id])
  deletedAt      DateTime?

  @@unique([roleId, permissionId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserRole {
  id       String @id @default(cuid())
  userId   String
  roleId   String
  role     Role   @relation(fields: [roleId], references: [id])
  user     User   @relation(fields: [userId], references: [id])
  deletedAt DateTime?

  @@unique([userId, roleId])
  @@index([roleId])
  @@map("user_roles")
}

model Office {

  id                  String           @id @default(cuid())
  name                String
  location            String?

  gps_latitude       Float
  gps_longitude      Float
   
  phone             String?
  email             String?          


  logo                String?          
  stamp               String?  

  parentId            String?
  parent              Office?          @relation("OfficeHierarchy", fields: [parentId], references: [id])

  children            Office[]         @relation("OfficeHierarchy")

  users               User[]
  authoredLetters     Letter[] 
  employees           Employee[]
  appointments        Appointment[]
  announcements      Announcement[]
  leaders             OfficeLeader[]
  directedLetters     DirectedLetter[] @relation("DirectedToOffice") 
  directedOutLetters  DirectedLetter[] @relation("directedFrom") 
  deletedAt           DateTime?


  @@index([parentId])
  @@map("offices")
}

model OfficeLeader {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  officeId  String
  office    Office   @relation(fields: [officeId], references: [id])

  startingDate  DateTime @default(now())
  endDate       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@unique([userId, officeId]) 
  @@index([officeId])
  @@map("office_leaders")
}

model Appointment {
  id          String   @id @default(cuid())
  date        DateTime
  subject     String
  description String?
  userId      String
  status      String 
  officeId    String?
  office      Office?  @relation(fields: [officeId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
  deletedAt   DateTime?

  @@index([officeId])
  @@index([userId])
  @@map("appointments")
}
model LeaveRequest{
   id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields:[employeeId],references:[id])
  approvedBy  String?
  user    User? @relation(fields:[approvedBy],references:[id])
  startDate      DateTime 
  daysOfLeave     Int
  endDate              DateTime
  leaveType            LeaveType?
  status              APPROVALSTATUS @default(PENDING)
  attachmentUrl      String?
  @@map("leave_requests")  
}

model Letter {
  id           String           @id @default(cuid())
  subject      String
  body         String
  status       String 
  userId       String
  user         User             @relation(fields: [userId], references: [id])
  officeId     String?
  office       Office?          @relation(fields: [officeId], references: [id])
  approvedBy   String?
  approved     User?            @relation("ApprovedLetters", fields: [approvedBy], references: [id])
  directed     DirectedLetter[]
  issuedAt     DateTime         @default(now())
  deletedAt    DateTime?

  @@index([approvedBy])
  @@index([officeId])
  @@index([userId])
  @@map("letters")
}

model DirectedLetter {
  id           String   @id @default(cuid())
  letterId     String
  letter       Letter   @relation(fields:[letterId], references:[id])
  officeId     String
  fromOffice   Office   @relation("directedFrom", fields:[officeId], references:[id])
  toOfficeId   String
  toOffice     Office   @relation("DirectedToOffice", fields:[toOfficeId], references:[id])
  reason       String   @db.Text
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  @@index([letterId])
  @@index([toOfficeId])
  @@index([userId])
  @@map("directed_letters")
}

model Employee {
  id                String             @id @default(cuid())
  userId            String?            @unique
  user              User?              @relation(fields: [userId], references: [id])
  email             String? 
  name              String 
  middle_name       String
  last_name         String?
  gender            GENDER?
  phone             String?
  birthDate         DateTime? 
  placeOfBirth      String?
  maritusStatus     String? 
  photoURL          String?
  emergencyPerson   String?
  emergencyContact  String?
  emergencyRelation EmergencyRelation?
  officeId          String?
  office            Office?            @relation(fields: [officeId], references: [id])
  hireDate          DateTime?
  deviceId          String? 
  attendance        Attendance[]
  positions         EmployeePosition[] 
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  leaveRequests LeaveRequest[]
  

  deletedAt         DateTime?

  @@index([officeId])
  @@map("employees")
}

model EmployeePosition {
  id          String         @id @default(cuid())
  employeeId  String
  employee    Employee       @relation(fields:[employeeId], references:[id])
  positionId  String
  position    Position       @relation(fields:[positionId], references:[id])
  startDate   DateTime       @default(now())
  endDate     DateTime?
  status      APPROVALSTATUS @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  @@index([employeeId])
  @@index([positionId])
  @@map("employee_positions")
}

model Position {
  id            String             @id @default(cuid())
  name          String
  description   String?
  employees     EmployeePosition[]
  deletedAt     DateTime?

  @@map("positions")
}

model Attendance{
  id              String           @id @default(cuid())
  userId          String? 
  user            User?            @relation(fields: [userId], references: [id])
  employeeId      String? 
  employee        Employee?        @relation(fields: [employeeId], references: [id])
  date            DateTime         @db.Date
  status          AttendanceStatus?  
  details         AttendanceDetail[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([userId])
  @@index([employeeId])
  @@map("attendances")
}

model AttendanceDetail {
  id              String           @id @default(cuid())
  timestamp       DateTime
  gps_latitude    Float?
  gps_longitude   Float?
  deviceId        String? 
  attendanceId    String
  type            AttendanceType 
  attendance      Attendance @relation(fields:[attendanceId],references:[id])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@map("attendance_details")
}